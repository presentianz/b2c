<?php

    namespace AppBundle\Controller\Admin;

    use Symfony\Component\HttpFoundation\Request;
    use Symfony\Bundle\FrameworkBundle\Controller\Controller;
    use Sensio\Bundle\FrameworkExtraBundle\Configuration\Method;
    use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;

    use AppBundle\Entity\Product;
    use AppBundle\Form\ProductType;

    /**
     * Product controller.
     *
     * @Route("/admin/product")
     */
    class ProductController extends Controller
    {

        /**
         * Lists all Product entities.
         *
         * @Route("", name="admin_product")
         * @Method("GET")
         */
        public function indexAction(Request $request)
        {
            $keys = $request->query->get('keys');
            $sort = $request->query->get('sort');
            $page = $request->query->get('page');
            $item_no = $request->query->get('item_no');
            $widget = $request->query->get('widget');
            if (! (is_numeric($item_no) && $item_no > 1)) {
                $item_no = 20;
            }
            if (! $sort)
                $sort = 7;
            $em = $this->getDoctrine()->getManager();
            $data = $em->getRepository('AppBundle:Product')->searchProduct($keys, $sort, $page, $item_no, $widget);
            return $this->render('Admin/Product/index.html.twig', array(
                'data' => $data,
            ));
        }

        /**
         * Creates a new Product entity.
         *
         * @Route("/", name="admin_product_create")
         * @Method("POST")
         */
        public function createAction(Request $request)
        {
            $entity = new Product();
            $form = $this->createCreateForm($entity);
            $form->handleRequest($request);

            if ($form->isValid()) {
                $em = $this->getDoctrine()->getManager();
                $em->persist($entity);
                $em->flush();

                return $this->redirect($this->generateUrl('admin_product_show', array('id' => $entity->getId())));
            }
            return $this->render('Admin/Product/new.html.twig', array(
                'entity' => $entity,
                'form' => $form->createView(),
            ));
        }

        /**
         * Creates a form to create a Product entity.
         *
         * @param Product $entity The entity
         *
         * @return \Symfony\Component\Form\Form The form
         */
        private function createCreateForm(Product $entity)
        {
            $form = $this->createForm(new ProductType(), $entity, array(
                'action' => $this->generateUrl('admin_product_create'),
                'method' => 'POST',
            ));

            $form->add('submit', 'submit', array('label' => 'Create'));

            return $form;
        }

        /**
         * Displays a form to create a new Product entity.
         *
         * @Route("/new", name="admin_product_new")
         * @Method("GET")
         */
        public function newAction()
        {
            $entity = new Product();
            $entity->SetImageLink(uniqid());
            $form = $this->createCreateForm($entity);

            return $this->render('Admin/Product/new.html.twig', array(
                'entity' => $entity,
                'form' => $form->createView(),
            ));
        }


        /**
         * Displays a form to create a new Product entity.
         *
         * @Route("/excel", name="admin_product_manage_by_excel")
         * @Method("GET")
         */
        public function excelAction()
        {
            return $this->render('Admin/Product/manage_by_excel.html.twig');
        }



        /**
         * Finds and displays a Product entity.
         *
         * @Route("/{id}", name="admin_product_show")
         * @Method("GET")
         */
        public function showAction($id)
        {
            $em = $this->getDoctrine()->getManager();

            $entity = $em->getRepository('AppBundle:Product')->find($id);

            if (! $entity) {
                throw $this->createNotFoundException('Unable to find Product entity.');
            }

            $deleteForm = $this->createDeleteForm($id);

            return $this->render('Admin/Product/show.html.twig', array(
                'entity' => $entity,
                'delete_form' => $deleteForm->createView(),
            ));

        }

        /**
         * Displays a form to edit an existing Product entity.
         *
         * @Route("/{id}/edit", name="admin_product_edit")
         * @Method("GET")
         */
        public function editAction($id)
        {
            $em = $this->getDoctrine()->getManager();

            $entity = $em->getRepository('AppBundle:Product')->find($id);

            if (! $entity) {
                throw $this->createNotFoundException('Unable to find Product entity.');
            }

            $editForm = $this->createEditForm($entity);
            $deleteForm = $this->createDeleteForm($id);

            return $this->render('Admin/Product/edit.html.twig', array(
                'entity' => $entity,
                'edit_form' => $editForm->createView(),
                'delete_form' => $deleteForm->createView(),
            ));
        }

        /**
         * Creates a form to edit a Product entity.
         *
         * @param Product $entity The entity
         *
         * @return \Symfony\Component\Form\Form The form
         */
        private function createEditForm(Product $entity)
        {
            $form = $this->createForm(new ProductType(), $entity, array(
                'action' => $this->generateUrl('admin_product_update', array('id' => $entity->getId())),
                'method' => 'PUT',
            ));

            $form->add('submit', 'submit', array('label' => 'Update'));

            return $form;
        }

        /**
         * Edits an existing Product entity.
         *
         * @Route("/{id}", name="admin_product_update")
         * @Method("PUT")
         */
        public function updateAction(Request $request, $id)
        {
            $em = $this->getDoctrine()->getManager();

            $entity = $em->getRepository('AppBundle:Product')->find($id);

            if (! $entity) {
                throw $this->createNotFoundException('Unable to find Product entity.');
            }

            $deleteForm = $this->createDeleteForm($id);
            $editForm = $this->createEditForm($entity);
            $editForm->handleRequest($request);

            if ($editForm->isValid()) {
                $em->flush();

                return $this->redirectToRoute('admin_product_show', array('id' => $id));
            }

            return $this->render('Admin/Product/edit.html.twig', array(
                'entity' => $entity,
                'edit_form' => $editForm->createView(),
                'delete_form' => $deleteForm->createView(),
            ));
        }

        /**
         * Deletes a Product entity.
         *
         * @Route("/{id}", name="admin_product_delete")
         * @Method("DELETE")
         */
        public function deleteAction(Request $request, $id)
        {
            $form = $this->createDeleteForm($id);
            $form->handleRequest($request);

            if ($form->isValid()) {
                $em = $this->getDoctrine()->getManager();
                $entity = $em->getRepository('AppBundle:Product')->find($id);

                if (! $entity) {
                    throw $this->createNotFoundException('Unable to find Product entity.');
                }

                $em->remove($entity);
                $em->flush();
            }

            return $this->redirect($this->generateUrl('admin_product'));
        }

        /**
         * Creates a form to delete a Product entity by id.
         *
         * @param mixed $id The entity id
         *
         * @return \Symfony\Component\Form\Form The form
         */
        private function createDeleteForm($id)
        {
            return $this->createFormBuilder()->setAction($this->generateUrl('admin_product_delete', array('id' => $id)))->setMethod('DELETE')->add('submit', 'submit', array('label' => 'Delete'))->getForm();
        }
    }
